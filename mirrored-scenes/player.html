<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Player View</title>
<style>
html,body{margin:0;height:100vh;background:#000;overflow:hidden}
#wrap{position:relative;width:100vw;height:100vh;display:flex;align-items:center;justify-content:center;background:#000}
#stage{position:relative}
#bg{position:absolute;left:0;top:0}
#overlay{position:absolute;left:0;top:0;pointer-events:none}

#combatBar{position:absolute;top:0;left:0;right:0;height:48px;background:rgba(0,0,0,.45);backdrop-filter:blur(3px);color:#fff;display:flex;align-items:center;gap:.5rem;padding:0 .5rem;z-index:100;font:13px/1.2 system-ui,Arial,sans-serif;white-space:nowrap}
#combatBar .clock{font-weight:600;margin-right:.25rem;padding:.15rem .5rem;border-radius:9999px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.25)}
#combatBar .controls{display:inline-flex;gap:.35rem;align-items:center}
#combatBar .controls button{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.25);color:#fff;border-radius:8px;padding:.15rem .5rem;font-size:12px;cursor:pointer}
#combatBar .controls label{display:inline-flex;align-items:center;gap:.35rem;font-size:12px;opacity:.9}
#combatBar .title{opacity:.8;margin-left:.25rem}
#combatBar .chip{position:relative;display:inline-flex;flex-direction:column;justify-content:center;min-width:0;padding:.2rem .45rem;border:1px solid rgba(255,255,255,.25);border-radius:10px;margin-right:.35rem}
#combatBar .chip .name{font-weight:600}
#combatBar .chip .cond{font-size:11px;opacity:.8;line-height:1.1}
#combatBar .chip.active{border-color:#ffcc00;box-shadow:0 0 0 2px rgba(255,204,0,.35) inset}

#note{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.55);color:#fff;padding:18px 22px;border-radius:12px;border:1px solid rgba(255,255,255,.25);display:none;max-width:80vw;max-height:70vh;overflow:auto;z-index:25}
#note p{margin:0;white-space:pre-wrap;font-size:14px;line-height:1.4}
</style>
</head>
<body>
<div id="wrap">
  <div id="stage">
    <div id="combatBar" style="pointer-events:none">
      <span class="clock" id="turnClock">00:00</span>
      <span class="title">Combat:</span>
      <span id="combatList"></span>
    </div>
    <img id="bg" src="current-scene.webp" alt="map">
    <canvas id="overlay"></canvas>
    <div id="note"><p id="noteText"></p></div>
  </div>
</div>
<script>
(function(){
  const BASE = location.pathname.replace(/\/player\.html.*/,'').replace(/\/$/,'') || '/scenes';
  let COLS=19, ROWS=10, IMG_COLS=19, IMG_ROWS=10, showGrid=true;
  const wrap=document.getElementById('wrap'); const stage=document.getElementById('stage'); const bg=document.getElementById('bg'); const cv=document.getElementById('overlay'); const ctx=cv.getContext('2d');
  const combatList=document.getElementById('combatList'); const clockEl=document.getElementById('turnClock');
  const note=document.getElementById('note'); const noteText=document.getElementById('noteText');
  let currentHash=''; let state={hidden:[],highlight:[]}; let dpr=window.devicePixelRatio||1;

  let skew=0; let clock={running:true, elapsed:0, startAt:Date.now()}; let timer=null;

  function fmt(ms){const s=Math.max(0,Math.floor(ms/1000));const m=String(Math.floor(s/60)).padStart(2,'0');const ss=String(s%60).padStart(2,'0');return m+':'+ss;}
  function elapsed(){const now=Date.now()+skew; return clock.running? (clock.elapsed + (now-(clock.startAt||now))) : clock.elapsed; }
  function tick(){ clockEl.textContent=fmt(elapsed()); }
  function ensureTimer(){ if(!timer) timer=setInterval(tick,250); }
  function applyClock(p){ if(!p) return; skew=(p.serverTime||Date.now())-Date.now(); clock=p.clock||clock; tick(); ensureTimer(); }
  function renderCombat(c){ combatList.innerHTML=''; (c && c.list || []).forEach(it=>{ const s=document.createElement('span'); s.className='chip'+(it.id===c.activeId?' active':''); s.innerHTML='<span class="name">'+it.name+(typeof it.initiative==='number'?' ('+it.initiative+')':'')+'</span><span class="cond">'+(it.condition||'')+(typeof it.ac==='number'?' â€¢ AC '+it.ac:'')+'</span>'; combatList.appendChild(s); }); }

  function fit(){ const vw=wrap.clientWidth, vh=wrap.clientHeight;
    const unit = Math.min(vw/COLS, vh/ROWS);
    const W = Math.floor(COLS*unit), H = Math.floor(ROWS*unit);
    stage.style.width=W+'px'; stage.style.height=H+'px';
    const dpr=window.devicePixelRatio||1; cv.style.width=W+'px'; cv.style.height=H+'px'; cv.width=Math.round(W*dpr); cv.height=Math.round(H*dpr); ctx.setTransform(dpr,0,0,dpr,0,0);
    // image rect from image grid within overall grid; SNAP to whole cells
    const cw=W/COLS, ch=H/ROWS; const iW=cw*IMG_COLS, iH=ch*IMG_ROWS;
    let startCol = Math.round((COLS-IMG_COLS)/2); startCol = Math.max(0, Math.min(startCol, COLS-IMG_COLS));
    let startRow = Math.round((ROWS-IMG_ROWS)/2); startRow = Math.max(0, Math.min(startRow, ROWS-IMG_ROWS));
    const ix=startCol*cw, iy=startRow*ch;
    bg.style.left=ix+'px'; bg.style.top=iy+'px'; bg.style.width=iW+'px'; bg.style.height=iH+'px';
    draw(W,H);
  }
  function rectSnap(x,y,w,h){ const ex=0.5/(window.devicePixelRatio||1); return [Math.floor(x-ex), Math.floor(y-ex), Math.ceil(w+ex*2), Math.ceil(h+ex*2)]; }
  function draw(W,H){ const cw=W/COLS, ch=H/ROWS; ctx.clearRect(0,0,W,H); ctx.fillStyle='rgba(0,0,0,1)'; ctx.fillRect(0,0,W,H); ctx.globalCompositeOperation='destination-out'; state.hidden.forEach(k=>{ const [x,y]=k.split(',').map(Number); const r=rectSnap(x*cw,y*ch,cw,ch); ctx.fillRect(r[0],r[1],r[2],r[3]); }); ctx.globalCompositeOperation='source-over'; ctx.fillStyle='rgba(255,0,0,.35)'; state.highlight.forEach(k=>{ const [x,y]=k.split(',').map(Number); const r=rectSnap(x*cw,y*ch,cw,ch); ctx.fillRect(r[0],r[1],r[2],r[3]); }); if(showGrid){ ctx.strokeStyle='rgba(255,255,255,.22)'; ctx.lineWidth=1; const dpr=(window.devicePixelRatio||1); for(let c=0;c<=COLS;c++){ const gx=Math.round((c*cw)*dpr)/dpr; ctx.beginPath(); ctx.moveTo(gx,0); ctx.lineTo(gx,H); ctx.stroke(); } for(let r=0;r<=ROWS;r++){ const gy=Math.round((r*ch)*dpr)/dpr; ctx.beginPath(); ctx.moveTo(0,gy); ctx.lineTo(W,gy); ctx.stroke(); } } }
  const J=u=>fetch(u,{cache:'no-store'}).then(r=>r.json());
  function setImage(h){ const src='current-scene.webp'+(h?('?h='+h):'')+'&t='+Date.now(); bg.src=src; }
  function updateState(s){ state.hidden=s.hidden||[]; state.highlight=s.highlight||[]; draw(parseFloat(stage.style.width), parseFloat(stage.style.height)); }
  function updateGrid(g){ showGrid=!!g.show; draw(parseFloat(stage.style.width), parseFloat(stage.style.height)); }
  function updateConfig(c){ if(c.cols) COLS=c.cols; if(c.rows) ROWS=c.rows; if(c.imgCols) IMG_COLS=c.imgCols; if(c.imgRows) IMG_ROWS=c.imgRows; fit(); }
  function updateNote(n){ noteText.textContent=n.text||''; note.style.display=n.visible?'block':'none'; }
  Promise.all([ J(BASE+'/hash'), J(BASE+'/state'), J(BASE+'/grid'), J(BASE+'/config'), J(BASE+'/combat'), J(BASE+'/clock') ]).then(([h,s,g,cfg,cb,clk])=>{ currentHash=h.hash||''; setImage(currentHash); updateState(s); updateGrid(g); updateConfig(cfg); renderCombat(cb); applyClock(clk); });
  (function wsLoop(){
    const url=(location.protocol==='https:'?'wss://':'ws://')+location.host+BASE+'/ws';
    try{ const ws=new WebSocket(url);
      ws.onmessage=e=>{ const m=JSON.parse(e.data||'{}'); if(m.type==='hash'){ currentHash=m.hash||''; setImage(currentHash); J(BASE+'/state?hash='+currentHash).then(updateState); } else if(m.type==='state') updateState(m.state); else if(m.type==='grid') updateGrid(m); else if(m.type==='config') updateConfig(m.config||{}); else if(m.type==='combat') renderCombat(m.combat); else if(m.type==='clock') applyClock(m); };
      ws.onclose=()=>setTimeout(wsLoop,2000);
    }catch(e){ setTimeout(wsLoop,2000); }
  })();
  window.addEventListener('resize', fit);
  fit();
})();
</script>
</body>
</html>
