<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>GM Fog Controller</title>
<style>
:root{color-scheme:dark}
html,body{margin:0;height:100vh;background:#0b0b0b;color:#eee;font-family:system-ui,Arial,sans-serif;overflow:hidden}
#wrap{position:relative;width:100vw;height:100vh;display:flex;align-items:center;justify-content:center;background:#000}
#top{position:absolute;top:0;left:0;right:0;display:flex;gap:.5rem;align-items:flex-start;padding:.5rem;border-bottom:1px solid #222;flex-wrap:wrap;background:rgba(11,11,11,.9);z-index:30}
#stage{position:relative}
#bg{position:absolute;left:0;top:0}
#cv{position:absolute;left:0;top:0}

#combatBar{position:absolute;top:0;left:0;right:0;height:48px;background:rgba(0,0,0,.45);backdrop-filter:blur(3px);color:#fff;display:flex;align-items:center;gap:.5rem;padding:0 .5rem;z-index:100;font:13px/1.2 system-ui,Arial,sans-serif;white-space:nowrap}
#combatBar .clock{font-weight:600;margin-right:.25rem;padding:.15rem .5rem;border-radius:9999px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.25)}
#combatBar .controls{display:inline-flex;gap:.35rem;align-items:center}
#combatBar .controls button{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.25);color:#fff;border-radius:8px;padding:.15rem .5rem;font-size:12px;cursor:pointer}
#combatBar .controls label{display:inline-flex;align-items:center;gap:.35rem;font-size:12px;opacity:.9}
#combatBar .title{opacity:.8;margin-left:.25rem}
#combatBar .chip{position:relative;display:inline-flex;flex-direction:column;justify-content:center;min-width:0;padding:.2rem .45rem;border:1px solid rgba(255,255,255,.25);border-radius:10px;margin-right:.35rem}
#combatBar .chip .name{font-weight:600}
#combatBar .chip .cond{font-size:11px;opacity:.8;line-height:1.1}
#combatBar .chip.active{border-color:#ffcc00;box-shadow:0 0 0 2px rgba(255,204,0,.35) inset}

button,input,textarea{background:#1b1b1b;color:#eee;border:1px solid #333;border-radius:8px;padding:.4rem .6rem}
button{cursor:pointer}
/* Bottom drawer with tab; leaves only the tab visible when closed */
#bottom{position:fixed;left:0;right:0;bottom:0;background:#0e0e0e;border-top:1px solid #222;padding:96px 16px 16px;z-index:40;transform:translateY(calc(100% - 36px));transition:transform .18s ease-out}
#bottom.visible{transform:translateY(0)}
#bottom .row{display:flex;gap:.75rem;align-items:center;flex-wrap:wrap;margin-top:.25rem}
#bottomToggle{position:absolute;left:16px;top:-36px;height:32px;line-height:32px;background:#1b1b1b;border:1px solid #333;border-bottom:none;color:#ddd;border-top-left-radius:10px;border-top-right-radius:10px;padding:0 .9rem;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.35)}
label.inline{display:flex;align-items:center;gap:.35rem}
</style>
</head>
<body>
<div id="wrap">
  <div id="top">
    <button id="modeReveal" class="active">Reveal / Hide</button>
    <button id="modeHi">Highlight / Unhighlight</button>
    <button id="clearReveal">Clear Revealed</button>
    <button id="clearHi">Clear Highlights</button>
    <button id="showAll">Show All</button>
  </div>

  <div id="stage">
    <div id="combatBar">
      <span class="clock" id="turnClock">00:00</span>
      <div class="controls">
        <button id="pauseBtn">Pause</button>
        <button id="resetBtn">Reset</button>
        <label title="If checked, the timer starts running after Reset">
          <input type="checkbox" id="autoRunReset"> Start after reset
        </label>
      </div>
      <span class="title">Combat:</span><span id="combatList"></span>
    </div>
    <img id="bg" src="current-scene.webp" alt="map">
    <canvas id="cv"></canvas>
  </div>
</div>

<div id="bottom">
  <button id="bottomToggle">Config • v6.2</button>
  <div class="row">
    <strong>Overall Grid</strong>
    <span class="pill"><label class="inline">Squares X:<input type="number" id="cfgCols" step="1" value="19" min="1"></label></span>
    <span class="pill"><label class="inline">Squares Y:<input type="number" id="cfgRows" step="1" value="10" min="1"></label></span>
  </div>
  <div class="row">
    <strong>Image Grid</strong>
    <span class="pill"><label class="inline">Image Squares X:<input type="number" id="cfgImgCols" step="1" value="19" min="1"></label></span>
    <span class="pill"><label class="inline">Image Squares Y:<input type="number" id="cfgImgRows" step="1" value="10" min="1"></label></span>
  </div>
  <div class="row">
    <button id="saveCfg">Apply Config</button>
    <span class="pill"><label class="inline"><input type="checkbox" id="gridToggle" checked> Show Grid (players)</label></span>
  </div>
</div>

<script>
(function(){
  const BASE = location.pathname.replace(/\/server\.html.*/,'').replace(/\/$/,'') || '/scenes';
  const wrap=document.getElementById('wrap'); const stage=document.getElementById('stage'); const bg=document.getElementById('bg'); const cv=document.getElementById('cv'); const ctx=cv.getContext('2d');
  const combatList=document.getElementById('combatList'); const clockEl=document.getElementById('turnClock');
  const btnReveal=document.getElementById('modeReveal'); const btnHi=document.getElementById('modeHi');
  const btnClearReveal=document.getElementById('clearReveal'); const btnClearHi=document.getElementById('clearHi'); const btnShowAll=document.getElementById('showAll');
  const pauseBtn=document.getElementById('pauseBtn'); const resetBtn=document.getElementById('resetBtn'); const autoRunReset=document.getElementById('autoRunReset');

  // bottom config
  const bottom = document.getElementById('bottom'); const bottomToggle = document.getElementById('bottomToggle');
  const cfgCols = document.getElementById('cfgCols'); const cfgRows = document.getElementById('cfgRows');
  const cfgImgCols = document.getElementById('cfgImgCols'); const cfgImgRows = document.getElementById('cfgImgRows');
  const saveCfg = document.getElementById('saveCfg');
  const gridToggle = document.getElementById('gridToggle');

  let COLS=19, ROWS=10, IMG_COLS=19, IMG_ROWS=10, mode='hidden';
  let state={hidden:new Set(), highlight:new Set()};
  let skew=0; let clock={running:true, elapsed:0, startAt:Date.now()}; let timer=null;

  function fmt(ms){const s=Math.max(0,Math.floor(ms/1000));const m=String(Math.floor(s/60)).padStart(2,'0');const ss=String(s%60).padStart(2,'0');return m+':'+ss;}
  function elapsed(){const now=Date.now()+skew; return clock.running? (clock.elapsed + (now-(clock.startAt||now))) : clock.elapsed; }
  function tick(){ clockEl.textContent=fmt(elapsed()); }
  function ensureTimer(){ if(!timer) timer=setInterval(tick,250); }
  function applyClock(p){ if(!p) return; skew=(p.serverTime||Date.now())-Date.now(); clock=p.clock||clock; tick(); ensureTimer(); updateClockButtons(); }
  function updateClockButtons(){ pauseBtn.textContent = clock.running ? 'Pause' : 'Resume'; }

  function ability(it){ return (it.condition||'') + (typeof it.ac==='number'? (' • AC '+it.ac) : ''); }
  function renderCombat(c){ combatList.innerHTML=''; (c&&c.list||[]).forEach(it=>{ const s=document.createElement('span'); s.className='chip'+(it.id===c.activeId?' active':''); s.innerHTML='<span class="name">'+it.name+(typeof it.initiative==='number'?' ('+it.initiative+')':'')+'</span><span class="cond">'+ability(it)+'</span>'; combatList.appendChild(s); }); }

  function fit(){ const vw=wrap.clientWidth, vh=wrap.clientHeight;
    const unit = Math.min(vw/COLS, vh/ROWS);
    const W = Math.floor(COLS*unit), H = Math.floor(ROWS*unit);
    stage.style.width=W+'px'; stage.style.height=H+'px';
    // image rect from image grid within overall grid; SNAP to whole cells
    const cw=W/COLS, ch=H/ROWS; const iW=cw*IMG_COLS, iH=ch*IMG_ROWS;
    let startCol = Math.round((COLS-IMG_COLS)/2); startCol = Math.max(0, Math.min(startCol, COLS-IMG_COLS));
    let startRow = Math.round((ROWS-IMG_ROWS)/2); startRow = Math.max(0, Math.min(startRow, ROWS-IMG_ROWS));
    const ix=startCol*cw, iy=startRow*ch;
    bg.style.left=ix+'px'; bg.style.top=iy+'px'; bg.style.width=iW+'px'; bg.style.height=iH+'px';
    // canvas full stage
    const dpr=window.devicePixelRatio||1; cv.style.width=W+'px'; cv.style.height=H+'px'; cv.width=Math.round(W*dpr); cv.height=Math.round(H*dpr); ctx.setTransform(dpr,0,0,dpr,0,0);
    draw(W,H);
  }
  function rectSnap(x,y,w,h){ const ex=0.5/(window.devicePixelRatio||1); return [Math.floor(x-ex), Math.floor(y-ex), Math.ceil(w+ex*2), Math.ceil(h+ex*2)]; }
  function draw(W,H){ const cw=W/COLS, ch=H/ROWS; ctx.clearRect(0,0,W,H); ctx.fillStyle='rgba(0,0,0,.6)'; ctx.fillRect(0,0,W,H); ctx.globalCompositeOperation='destination-out'; state.hidden.forEach(k=>{ const [x,y]=k.split(',').map(Number); const r=rectSnap(x*cw,y*ch,cw,ch); ctx.fillRect(r[0],r[1],r[2],r[3]); }); ctx.globalCompositeOperation='source-over'; ctx.fillStyle='rgba(255,0,0,.35)'; state.highlight.forEach(k=>{ const [x,y]=k.split(',').map(Number); const r=rectSnap(x*cw,y*ch,cw,ch); ctx.fillRect(r[0],r[1],r[2],r[3]); }); /* ALWAYS show grid on GM */ ctx.strokeStyle='rgba(255,255,255,.22)'; ctx.lineWidth=1; const dpr=(window.devicePixelRatio||1); for(let c=0;c<=COLS;c++){ const gx=Math.round((c*cw)*dpr)/dpr; ctx.beginPath(); ctx.moveTo(gx,0); ctx.lineTo(gx,H); ctx.stroke(); } for(let r=0;r<=ROWS;r++){ const gy=Math.round((r*ch)*dpr)/dpr; ctx.beginPath(); ctx.moveTo(0,gy); ctx.lineTo(W,gy); ctx.stroke(); } }
  function keyFor(ev){ const r=cv.getBoundingClientRect(); const W=r.width, H=r.height; const x=Math.floor((ev.clientX-r.left)/(W/COLS)); const y=Math.floor((ev.clientY-r.top)/(H/ROWS)); return x+','+y; }
  function J(u){ return fetch(u,{cache:'no-store'}).then(r=>r.json()); }
  function pushOps(ops){ return fetch(BASE+'/state',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({ops})}); }

  // Config panel behaviors
  bottomToggle.addEventListener('click', ()=>{ bottom.classList.toggle('visible'); });

  function loadGlobals(){
    J(BASE+'/grid').then(g=>{ gridToggle.checked = !!(g && g.show); }).catch(()=>{}); // only informs players
    J(BASE+'/config').then(c=>{ 
      cfgCols.value=c.cols||19; cfgRows.value=c.rows||10; 
      cfgImgCols.value=c.imgCols||c.cols||19; cfgImgRows.value=c.imgRows||c.rows||10;
      COLS=c.cols||19; ROWS=c.rows||10; IMG_COLS=c.imgCols||COLS; IMG_ROWS=c.imgRows||ROWS; 
      fit(); 
    }).catch(()=>{});
  }
  loadGlobals();

  ;[cfgCols,cfgRows,cfgImgCols,cfgImgRows].forEach(el=> el.addEventListener('input', ()=>{ 
    COLS=Math.max(1, Number(cfgCols.value)||19); ROWS=Math.max(1, Number(cfgRows.value)||10);
    IMG_COLS=Math.max(1, Number(cfgImgCols.value)||COLS); IMG_ROWS=Math.max(1, Number(cfgImgRows.value)||ROWS);
    fit(); 
  }));

  saveCfg.addEventListener('click', ()=>{
    COLS=Math.max(1, Number(cfgCols.value)||19);
    ROWS=Math.max(1, Number(cfgRows.value)||10);
    IMG_COLS=Math.max(1, Number(cfgImgCols.value)||COLS);
    IMG_ROWS=Math.max(1, Number(cfgImgRows.value)||ROWS);
    const body={ cols:COLS, rows:ROWS, imgCols:IMG_COLS, imgRows:IMG_ROWS };
    fetch(BASE+'/config',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}).then(()=>{ /* keep view */ });
  });
  gridToggle.addEventListener('change', ()=>{
    // Only updates players; GM always shows grid
    const body={ show: !!gridToggle.checked };
    fetch(BASE+'/grid',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  });

  btnShowAll.addEventListener('click',()=>{ const keys=[]; for(let y=0;y<ROWS;y++) for(let x=0;x<COLS;x++) keys.push(x+','+y); state.hidden=new Set(keys); fit(); pushOps(keys.map(k=>({type:'set',mode:'hidden',key:k,value:true}))); });

  pauseBtn.addEventListener('click',()=>{ fetch(BASE+'/clock',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'toggle'})}); });
  resetBtn.addEventListener('click',()=>{ fetch(BASE+'/clock',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'reset'})}); });

  btnReveal.onclick=()=>{ mode='hidden'; btnReveal.classList.add('active'); btnHi.classList.remove('active'); };
  btnHi.onclick=()=>{ mode='highlight'; btnHi.classList.add('active'); btnReveal.classList.remove('active'); };
  btnClearReveal.onclick=()=>{ const ops=[{type:'clear',mode:'hidden'}]; state.hidden.clear(); fit(); pushOps(ops); };
  btnClearHi.onclick=()=>{ const ops=[{type:'clear',mode:'highlight'}]; state.highlight.clear(); fit(); pushOps(ops); };

  cv.addEventListener('click',(ev)=>{ const k=keyFor(ev); const set=(mode==='highlight')? state.highlight : state.hidden; if(set.has(k)) set.delete(k); else set.add(k); fit(); pushOps([{type:'toggle',mode:mode,key:k}]); });

  Promise.all([J(BASE+'/combat'),J(BASE+'/clock')]).then(([cb,clk])=>{ renderCombat(cb); applyClock(clk); });

  (function wsLoop(){
    const url=(location.protocol==='https:'?'wss://':'ws://')+location.host+BASE+'/ws';
    try{ const ws=new WebSocket(url);
      ws.onmessage=e=>{ const m=JSON.parse(e.data||'{}'); if(m.type==='combat') renderCombat(m.combat); else if(m.type==='clock') applyClock(m); else if(m.type==='state'){ state.hidden=new Set(m.state.hidden||[]); state.highlight=new Set(m.state.highlight||[]); fit(); } else if (m.type==='config'){ const c=m.config||{}; 
          cfgCols.value=c.cols||19; cfgRows.value=c.rows||10; cfgImgCols.value=c.imgCols||c.cols||19; cfgImgRows.value=c.imgRows||c.rows||10;
          COLS=c.cols||19; ROWS=c.rows||10; IMG_COLS=c.imgCols||COLS; IMG_ROWS=c.imgRows||ROWS;
          fit(); 
        } else if(m.type==='grid'){ /* players only */ } else if(m.type==='hash'){ /* no-op */ } };
      ws.onclose=()=>setTimeout(wsLoop,2000);
    }catch(e){ setTimeout(wsLoop,2000); }
  })();

  // Initial
  window.addEventListener('resize', fit);
  fit();
})();
</script>
</body>
</html>
